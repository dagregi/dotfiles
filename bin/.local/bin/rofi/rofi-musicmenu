#!/usr/bin/env bash

COVER_PATH="/tmp"
status=$(mpc status)

ARTIST=$(mpc current -f %artist%)
ALBUM="󰀥  $(mpc current -f %album%)"
TITLE="󰝚  $(mpc current -f %title%)"

is_stopped=$(mpc status | awk '{ print $2 }')
is_repeat=$(mpc status | awk '/repeat/ { print $4 }')
is_random=$(mpc status | awk '/random/ { print $6 }')
is_playing=$(mpc status | awk '/\[/ { print $1 }' | tr -d '\[\]')

[ -z "$status" ] && {
	prompt="Offline"
	message="MPD is Offline"
} || [ "$is_stopped" = "n/a" ] && {
	prompt="Stopped"
	message="Playback stopped"
}
[ -e "$COVER_PATH/$ALBUM-raw.png" ] && cover="$COVER_PATH/$ALBUM-raw.png" || {
	mpc readpicture "$(mpc current -f %file%)" >"$COVER_PATH/$ALBUM-raw.png" 2>/dev/null && cover="$COVER_PATH/$ALBUM-raw.png"
} || {
	prompt="$ARTIST"
	message="""$TITLE
$ALBUM"""
}

toggle_play_pause() {
	[ -n "$status" ] && mpc -q toggle && dunstify -t 900 "$(mpc status | awk '/\[/ { print $1 }' | tr -d '\[\]' | sed 's/p/P/')" || exit 0
}
stop_palyback() {
	mpc -q stop
	dunstify -t 900 "Playback stopped"
}
toggle_random() {
	[ -n "$status" ] && mpc -q random && dunstify -t 900 "Random: $(mpc status | awk '/repeat/ { print $6 }')" || exit 0
}
toggle_repeat() {
	[ -n "$status" ] && mpc -q repeat && dunstify -t 900 "Repeat: $(mpc status | awk '/repeat/ { print $4 }')" || exit 0
}
next_track() {
	[ "$is_stopped" != "n/a" ] && [ -n "$status" ] && mpc -q next && songchanged || exit 0
}
prev_track() {
	[ "$is_stopped" != "n/a" ] && [ -n "$status" ] && mpc -q prev && songchanged || exit 0
}

[ "$is_playing" = "playing" ] && toggle_opt="󰏤" || toggle_opt="󰐊"
prev_opt="󰒮"
next_opt="󰒭"
stop_opt="󰓛"
random_opt="󰒝"
repeat_opt="󰑖"

[ "$is_repeat" = "on" ] && [ "$is_random" = "on" ] && active="4,5" ||
	[ "$is_repeat" = "on" ] && active="4" || [ "$is_random" = "on" ] && active="5" || active=""

urgent=""
[ "$is_stopped" = "n/a" ] && urgent="3"

opt_menu() {
	rofi -dmenu \
		-selected-row 1 \
		-theme-str "inputbar {background-image: url(\""$cover"\", width);}" \
		-p "$prompt" \
		-mesg "$message" \
		-a "${active}" -u "$urgent" \
		-theme $XDG_CONFIG_HOME/rofi/themes/musicdash.rasi
}

run_rofi() {
	echo "$prev_opt\n$toggle_opt\n$next_opt\n$stop_opt\n$repeat_opt\n$random_opt" | opt_menu
}
state=$(run_rofi)

case "$state" in
"$toggle_opt") toggle_play_pause
	;;
"$stop_opt") stop_palyback
	;;
"$next_opt") next_track
	;;
"$prev_opt") prev_track
	;;
"$repeat_opt") toggle_repeat
	;;
"$random_opt") toggle_random
	;;
*) echo "Don't know what to do"
	;;
esac
